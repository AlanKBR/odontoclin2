{% extends 'core/base.html' %}
{% block title %}Nova Receita{% endblock %}
{% block content %}
<h1>Nova Receita</h1>
<form id="form-receita" method="post" action="#" onsubmit="return false;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="row g-2">
        <div class="col-md-4">
            <label class="form-label">Paciente</label>
            <select class="form-select form-select-sm" name="paciente_id" id="paciente_sel">
                <option value="">-- selecione --</option>
                {% for p in pacientes %}
                <option value="{{ p.id }}">{{ p.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Dentista</label>
            <select class="form-select form-select-sm" name="dentista_id" id="dentista_sel">
                <option value="">-- selecione --</option>
                {% for d in dentistas %}
                <option value="{{ d.id }}">{{ d.nome_completo }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Data</label>
            <input class="form-control form-control-sm" name="data" value="{{ now.strftime('%d/%m/%Y') }}" />
        </div>
    </div>
    <hr />
    <div>
    <label class="form-label">Texto da Receita</label>
    <!-- larger textarea for composing recipes -->
    <textarea id="texto_receita" name="texto" class="form-control" rows="18" style="min-height:360px;" placeholder="Escreva a receita aqui. Você pode inserir medicamentos clicando em 'Detalhes' e depois 'Selecionar' ou clicando diretamente no princípio ativo nas buscas."></textarea>
    </div>
    <div id="med-detail-global" class="mt-3"></div>
    <hr />
    <div class="row">
        <div class="col-md-6">
            <label class="form-label">Buscar medicamentos</label>
            <input id="med-search" name="q" class="form-control form-control-sm" 
                hx-get="{{ url_for('receitas.buscar_medicamentos_htmx') }}"
                hx-trigger="keyup changed delay:500ms"
                hx-target="#med-results" placeholder="Digite categoria, princípio ativo ou nome referência" />
        </div>
    </div>
    <div id="med-results" class="mt-2">
        {% set row_id = 0 %}
        {% include 'receitas/_med_search_results.html' %}
    </div>
    <div class="mt-3">
        <button class="btn btn-primary btn-sm" id="preview_btn">Preview</button>
        <button class="btn btn-success btn-sm" id="emitir_btn">Emitir</button>
    </div>
    <div id="preview_area" class="mt-3"></div>
</form>

<script>
// Delegated handler: when user clicks a .med-select link, call selecionar_medicamento
// When user clicks a med-select link (principio ativo), fetch med info and insert into the main textarea at caret
document.addEventListener('click', function (e) {
    const el = e.target.closest('.med-select');
    if (!el) return;
    e.preventDefault();
    const medId = (() => {
        try {
            const v = el.getAttribute('hx-vals');
            if (v) return JSON.parse(v).med_id;
        } catch (err) {}
        return el.dataset.medId;
    })();
    if (!medId) return;
    // include CSRF token from hidden input so server won't reject the POST
    const csrf = document.querySelector('input[name="csrf_token"]')?.value || '';
    fetch('{{ url_for("receitas.selecionar_medicamento") }}', {
        method: 'POST',
        headers: {
            'Content-Type':'application/json',
            'X-CSRFToken': csrf,
            'X-CSRF-Token': csrf
        },
        body: JSON.stringify({med_id: medId, csrf_token: csrf}),
    })
    .then(r => r.json())
        .then(payload => {
        const ta = document.getElementById('texto_receita');
        if (!ta) return;
        // prefer to show 'Princípio Ativo — Apresentação' then posologia
        const principio = payload.medicamento_text || '';
        const apresentacao = (payload.apresentacao || '').trim();
        const header = apresentacao ? `${principio} — ${apresentacao}` : principio;
        const insertText = header + '\n' + (payload.posologia || '') + '\n\n';
        // insert at cursor
        const start = ta.selectionStart || 0;
        const end = ta.selectionEnd || 0;
        const before = ta.value.substring(0, start);
        const after = ta.value.substring(end);
        ta.value = before + insertText + after;
        // move caret after inserted text
        const newPos = before.length + insertText.length;
        ta.selectionStart = ta.selectionEnd = newPos;
        ta.focus();
    })
    .catch(() => {});
});

async function collectForm(){
    const form = document.getElementById('form-receita');
    const formData = new FormData(form);
    const data = {
        paciente_id: formData.get('paciente_id'),
        dentista_id: formData.get('dentista_id'),
        texto: document.getElementById('texto_receita').value,
        notas: ''
    };
    return data;
}

document.getElementById('preview_btn').addEventListener('click', async function(e){
    e.preventDefault();
    const data = await collectForm();
    const csrf = document.querySelector('input[name="csrf_token"]')?.value || '';
    const resp = await fetch("{{ url_for('receitas.preview_receita') }}", {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': csrf, 'X-CSRF-Token': csrf},
        body: JSON.stringify(Object.assign({csrf_token: csrf}, data))
    });
    const html = await resp.text();
    document.getElementById('preview_area').innerHTML = html;
});

document.getElementById('emitir_btn').addEventListener('click', async function(e){
    e.preventDefault();
    const data = await collectForm();
    const csrf = document.querySelector('input[name="csrf_token"]')?.value || '';
    const resp = await fetch("{{ url_for('receitas.emitir_receita') }}", {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': csrf, 'X-CSRF-Token': csrf},
        body: JSON.stringify(Object.assign({csrf_token: csrf}, data))
    });
    if(resp.status === 200){
        const json = await resp.json();
        window.location = json.print_url;
    } else {
        const text = await resp.text();
        document.getElementById('preview_area').innerHTML = text;
    }
});
</script>

{% endblock %}
