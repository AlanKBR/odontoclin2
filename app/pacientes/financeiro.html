{% extends 'core/base.html' %}
{% block title %}Financeiro - {{ paciente.nome }}{% endblock %}
{% block content %}
<h1>Financeiro - {{ paciente.nome }}</h1>
<p>
    <a href="{{ url_for('pacientes.novo_financeiro', paciente_id=paciente.id) }}">Tela Completa de Novo Lançamento</a>
    | <a href="{{ url_for('pacientes.visualizar', paciente_id=paciente.id) }}">Voltar</a>
</p>
<div id="financeiro-totais" class="mb-2"
    hx-get="{{ url_for('pacientes.financeiros_totais_htmx', paciente_id=paciente.id) }}"
    hx-trigger="load, financeiroUpdated from:body" hx-swap="outerHTML">
    {# Render totals server-side first for deterministic tests; HTMX will refresh after load #}
    {% include 'pacientes/partials/_financeiro_totais.html' %}
</div>
<details class="mb-2">
    <summary>Novo lançamento rápido</summary>
    <form id="financeiro-quick-form" hx-post="{{ url_for('pacientes.novo_financeiro_htmx', paciente_id=paciente.id) }}"
        hx-target="#financeiro-rows" hx-swap="beforeend" class="inline-form">
        {{ form_inline.csrf_token }}
        <input type="text" name="descricao" placeholder="Descrição" required>
        <input type="number" step="0.01" name="valor" placeholder="Valor" required>
        <select name="tipo">
            <option value="Crédito">Crédito</option>
            <option value="Débito">Débito</option>
        </select>
        <select name="status">
            <option value="Pendente">Pendente</option>
            <option value="Pago">Pago</option>
            <option value="Cancelado">Cancelado</option>
        </select>
        <select name="forma_pagamento">
            <option value="Dinheiro">Dinheiro</option>
            <option value="Pix">Pix</option>
            <option value="Cartão de Crédito">Cartão de Crédito</option>
            <option value="Cartão de Débito">Cartão de Débito</option>
            <option value="Transferência">Transferência</option>
            <option value="Boleto">Boleto</option>
        </select>
        <button type="submit">Adicionar</button>
        <div id="inline-financeiro-messages" class="inline-form-messages" hx-swap="innerHTML"></div>
    </form>
</details>
{% if lancamentos %}
<table>
    <thead>
        <tr>
            <th>Data</th>
            <th>Descrição</th>
            <th>Valor</th>
            <th>Tipo</th>
            <th>Status</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody id="financeiro-rows">
        {% for f in lancamentos %}
        {% include 'pacientes/partials/_financeiro_row.html' %}
        {% endfor %}
    </tbody>
</table>
<div class="pagination">
    {% if page > 1 %}
    <a href="{{ url_for('pacientes.financeiro', paciente_id=paciente.id, page=page-1) }}">&laquo; Anterior</a>
    {% endif %}
    <span>Página {{ page }} de {{ pages }}</span>
    {% if page < pages %} <a href="{{ url_for('pacientes.financeiro', paciente_id=paciente.id, page=page+1) }}">Próxima
        &raquo;</a>
        {% endif %}
</div>
{% else %}
<p>Nenhum lançamento.</p>
{% endif %}
<script>
    // Limpa formulário inline após criação bem-sucedida
    document.addEventListener('htmx:afterRequest', function (evt) {
        var form = document.getElementById('financeiro-quick-form');
        if (!form) return;
        if (evt.target === form && evt.detail.xhr && evt.detail.xhr.status === 200) {
            if (typeof form.reset === 'function') { form.reset(); }
            var box = document.getElementById('inline-financeiro-messages');
            if (box) { box.innerHTML = ''; }
        }
    });
</script>
{% endblock %}